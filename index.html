<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2DUELS PIXEL OS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --green: #00ff41; --red: #ff0000; --bg: #000; --pixel: 4px; --gold: #ffd700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; image-rendering: pixelated; }
        body { background: var(--bg); color: #fff; font-family: 'Press Start 2P', cursive; margin: 0; overflow: hidden; height: 100vh; font-size: 8px; }
        
        /* HEADER */
        .header { padding: 15px; border-bottom: var(--pixel) solid #222; display: flex; justify-content: space-between; align-items: center; background: #080808; }
        .stars-bal { color: var(--gold); }

        /* MENU */
        .menu { padding: 15px; display: grid; grid-template-columns: 1fr; gap: 10px; overflow-y: auto; height: calc(100vh - 120px); }
        .card { background: #111; border: var(--pixel) solid #333; padding: 15px; position: relative; transition: 0.1s; }
        .card:active { border-color: var(--green); transform: scale(0.98); }
        .card h3 { margin: 0; font-size: 10px; color: var(--green); }
        .card p { font-size: 6px; color: #666; margin: 8px 0 0; }

        /* OVERLAYS */
        .screen { display: none; position: fixed; inset: 0; background: #000; z-index: 100; flex-direction: column; align-items: center; padding: 20px; }
        .top-nav { width: 100%; display: flex; justify-content: space-between; margin-bottom: 30px; color: var(--red); }

        /* GAMES VISUALS */
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 240px; }
        .tile { aspect-ratio: 1; background: #222; border: var(--pixel) solid #444; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .tile.selected { border-color: var(--red); background: #300; }
        .tile.open { border-color: var(--green); background: #030; }

        .gun { width: 100px; height: 50px; background: #777; position: relative; margin: 40px 0; border: 4px solid #444; }
        .gun::after { content: ''; position: absolute; left: -20px; bottom: -30px; width: 40px; height: 50px; background: #555; }
        .flash { position: fixed; inset: 0; background: white; display: none; z-index: 200; }

        .coin { width: 60px; height: 60px; background: var(--gold); border: 4px solid #b8860b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #b8860b; transition: 0.1s; }
        .flipping { animation: flip 0.2s infinite; }
        @keyframes flip { 0% { transform: scaleX(1); } 50% { transform: scaleX(0); } 100% { transform: scaleX(1); } }

        /* BOTTOM NAV */
        .bottom-bar { position: fixed; bottom: 0; width: 100%; height: 60px; border-top: var(--pixel) solid #222; display: flex; justify-content: space-around; align-items: center; background: #080808; }
        .nav-item { color: #444; font-size: 6px; }
        .nav-item.active { color: var(--green); }
    </style>
</head>
<body>

<div id="lobby">
    <div class="header">
        <div>ID:<span id="uid">0000</span></div>
        <div class="stars-bal">‚≠ê<span id="bal">1250</span></div>
    </div>
    <div class="menu">
        <div class="card" onclick="openGame('mines')"><h3>MINES 3x3</h3><p>PVP: SET 3 TRAPS & SURVIVE</p></div>
        <div class="card" onclick="openGame('roulette')"><h3>ROULETTE</h3><p>1 BULLET. 6 CHAMBERS. FEEL LUCKY?</p></div>
        <div class="card" onclick="openGame('coin')"><h3>COIN FLIP</h3><p>DOUBLE YOUR STARS OR LOSE ALL</p></div>
        <div class="card" onclick="openGame('rps')"><h3>PVP DUEL (RPS)</h3><p>ROCK, PAPER, SCISSORS BATTLE</p></div>
    </div>
</div>

<div id="mines-screen" class="screen">
    <div class="top-nav" onclick="closeGame()">[BACK]</div>
    <div id="m-status">–ó–ê–ú–ò–ù–ò–†–£–ô 3 –ö–õ–ï–¢–ö–ò</div>
    <div class="grid-3" id="m-grid"></div>
    <button id="m-btn" style="margin-top:20px; background:var(--green); border:none; padding:10px; font-family:'Press Start 2P'; font-size:8px; display:none;" onclick="confirmMines()">BATTLE!</button>
</div>

<div id="roulette-screen" class="screen">
    <div class="top-nav" onclick="closeGame()">[BACK]</div>
    <div class="gun" id="gun-obj"></div>
    <div id="r-status">CYLINDER READY</div>
    <button style="margin-top:40px; background:var(--red); color:white; border:none; padding:15px; font-family:'Press Start 2P';" onclick="pullTrigger()">PULL TRIGGER</button>
</div>

<div id="coin-screen" class="screen">
    <div class="top-nav" onclick="closeGame()">[BACK]</div>
    <div class="coin" id="coin-obj">$</div>
    <button style="margin-top:50px; background:var(--gold); border:none; padding:15px; font-family:'Press Start 2P';" onclick="startFlip()">FLIP</button>
</div>

<div id="rps-screen" class="screen">
    <div class="top-nav" onclick="closeGame()">[BACK]</div>
    <div id="rps-status" style="margin-bottom:30px;">CHOOSE WEAPON</div>
    <button class="card" style="width:100%; color:white;" onclick="playRPS('‚úä')">ROCK</button>
    <button class="card" style="width:100%; color:white;" onclick="playRPS('‚úã')">PAPER</button>
    <button class="card" style="width:100%; color:white;" onclick="playRPS('‚úåÔ∏è')">SCISSORS</button>
</div>

<div class="flash" id="flash-fx"></div>
<div class="bottom-bar">
    <div class="nav-item active">GAMES</div>
    <div class="nav-item">BANK</div>
    <div class="nav-item">STATS</div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    // --- –ó–í–£–ö–û–í–û–ô –î–í–ò–ñ–û–ö (PIXEL SOUNDS) ---
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let ctx = null;

    function initAudio() { if(!ctx) ctx = new AudioCtx(); }

    function playNote(freq, dur, type="square") {
        initAudio();
        let osc = ctx.createOscillator();
        let gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + dur);
    }

    // –ú—É–∑—ã–∫–∞ –ª–æ–±–±–∏ (–∑–∞—Ü–∏–∫–ª–µ–Ω–Ω–∞—è)
    function startMusic() {
        setInterval(() => {
            playNote(220, 0.1); setTimeout(() => playNote(261, 0.1), 200);
        }, 800);
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–† ---
    function openGame(id) {
        initAudio();
        playNote(440, 0.05);
        document.getElementById('lobby').style.display = 'none';
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(id + '-screen').style.display = 'flex';
        if(id === 'mines') resetMines();
        if(id === 'roulette') resetRoulette();
    }

    function closeGame() {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById('lobby').style.display = 'block';
    }

    // MINES 3x3
    let playerMines = [];
    let enemyMines = [];
    function resetMines() {
        playerMines = [];
        let grid = document.getElementById('m-grid');
        grid.innerHTML = '';
        for(let i=0; i<9; i++) {
            let t = document.createElement('div');
            t.className = 'tile';
            t.onclick = () => {
                if(playerMines.includes(i)) return;
                if(playerMines.length < 3) {
                    playerMines.push(i);
                    t.classList.add('selected');
                    playNote(300, 0.1);
                    if(playerMines.length === 3) document.getElementById('m-btn').style.display = 'block';
                }
            };
            grid.appendChild(t);
        }
    }
    function confirmMines() {
        enemyMines = [0, 1, 2, 3, 4, 5, 6, 7, 8].sort(() => 0.5 - Math.random()).slice(0, 3);
        document.getElementById('m-status').innerText = "–ë–ò–¢–í–ê! –ò–©–ò –ß–ò–°–¢–´–ï –ö–õ–ï–¢–ö–ò";
        document.getElementById('m-btn').style.display = 'none';
        document.querySelectorAll('.tile').forEach((t, i) => {
            t.classList.remove('selected');
            t.onclick = () => {
                if(t.classList.contains('open')) return;
                t.classList.add('open');
                if(enemyMines.includes(i)) {
                    t.innerText = 'üí£'; t.style.background = 'red';
                    playNote(100, 0.3, "sawtooth");
                    tg.HapticFeedback.notificationOccurred('error');
                } else {
                    t.innerText = 'üíé';
                    playNote(800, 0.1);
                }
            };
        });
    }

    // ROULETTE
    let bullet = 0;
    function resetRoulette() { bullet = Math.floor(Math.random()*6); }
    function pullTrigger() {
        let current = Math.floor(Math.random()*6);
        if(current === bullet) {
            document.getElementById('flash-fx').style.display = 'block';
            playNote(50, 0.5, "sawtooth");
            tg.HapticFeedback.notificationOccurred('error');
            setTimeout(() => { document.getElementById('flash-fx').style.display = 'none'; alert("WASTED"); closeGame(); }, 100);
        } else {
            playNote(400, 0.05);
            document.getElementById('r-status').innerText = "CLICK... SAFE";
            tg.HapticFeedback.impactOccurred('light');
        }
    }

    // COIN
    function startFlip() {
        let c = document.getElementById('coin-obj');
        c.classList.add('flipping');
        playNote(600, 0.5);
        setTimeout(() => {
            c.classList.remove('flipping');
            let win = Math.random() > 0.5;
            c.innerText = win ? "G" : "B";
            playNote(win ? 1000 : 200, 0.2);
        }, 1000);
    }

    // RPS
    function playRPS(user) {
        let options = ['‚úä', '‚úã', '‚úåÔ∏è'];
        let bot = options[Math.floor(Math.random()*3)];
        playNote(500, 0.1);
        alert(`BOT: ${bot} | YOU: ${user}`);
    }

    // –ü–µ—Ä–≤–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∑–≤—É–∫–∞
    window.onclick = () => { if(!ctx) { initAudio(); startMusic(); } };

    if(tg.initDataUnsafe?.user) {
        document.getElementById('uid').innerText = tg.initDataUnsafe.user.id.toString().slice(-4);
    }
</script>
</body>
</html>
